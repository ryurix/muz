<?php

header('Content-Type: application/json');

$args = file_get_contents('php://input');

$json = \Flydom\Json::decode(\Flydom\Json::fix($args));

$id = \Flydom\Clean::int($json['id'] ?? 0);

$row = \Db::fetchRow(\Db::select('*', 'orst', ['i'=>$id]));

if (!is_array($row)) {
	echo '"order not found: '.$id.' ('.$args.' '.\Flydom\Cache::encode($_REQUEST).')"';
	exit;
}

$order = new \Order\Model($id);

$update = [];

if (isset($json['staff'])) {
	$update['staff'] = 1;
	$order->setStaff(\Flydom\Clean::int($json['staff']));
}

if (isset($json['state'])) {
	$update['state'] = 1;
	$order->setState(\Flydom\Clean::int($json['state']));
}

if (isset($json['vendor'])) {
	$update['vendor'] = 1;
	$order->setVendor(\Flydom\Clean::int($json['vendor']));
}

if (isset($json['info'])) {
	$update['info'] = 1;
	$order->setInfo($json['info']);
}

if (isset($json['note'])) {
	$update['note'] = 1;
	$order->setNote($json['note']);
}

if (count($update)) {
	foreach ($update as $k=>$v) {
		\Flydom\Log::add(602, $row['i'], $k.': '.$row[$k]);
	}
	$order->save();
	echo '"ok"';
	exit;
}

echo '"no data"';
