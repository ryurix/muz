<?php

header('Content-Type: application/json');

$args = file_get_contents('php://input');

$json = \Flydom\Json::decode(\Flydom\Json::fix($args));

$id = $json['id'] ?? 0;

$row = \Db::fetchRow(\Db::select('*', 'orst', ['i'=>$id]));

if (!is_array($row)) {
	echo '"order not found: '.$id.' ('.$args.' '.\Flydom\Cache::encode($_REQUEST).')"';
	exit;
}

$update = [];

if (isset($json['staff'])) {
	$update['staff'] = \Flydom\Clean::int($json['staff']);
}

if (isset($json['state'])) {
	$update['state'] = \Flydom\Clean::int($json['state']);
}

if (isset($json['vendor'])) {
	$update['vendor'] = \Flydom\Clean::int($json['vendor']);
}

if (isset($json['info'])) {
	$update['info'] = $json['info'];
}

if (isset($json['note'])) {
	$update['note'] = $json['note'];
}

if (count($update)) {
	foreach ($update as $k=>$v) {
		\Flydom\Log::add(602, $row['i'], $k.': '.$row[$k]);
	}
	$update['last'] = \Config::now();
	\Db::update('orst', $update, ['i'=>$id]);
	echo '"ok"';
	exit;
}

echo '"no data"';
